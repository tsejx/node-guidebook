---
nav:
  title: ç³»ç»Ÿ
  order: 3
group:
  title: è¿›ç¨‹
  order: 1
title: è¿›ç¨‹
order: 1
---

# è¿›ç¨‹

å…³äº Processï¼Œæˆ‘ä»¬éœ€è¦è®¨è®ºçš„æ˜¯ä¸¤ä¸ªæ¦‚å¿µ â‘  æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ï¼Œâ‘¡ Node.js ä¸­çš„ Process å¯¹è±¡ã€‚æ“ä½œè¿›ç¨‹å¯¹äºæœåŠ¡ç«¯è€Œè¨€ï¼Œå¥½æ¯” HTML ä¹‹äºå‰ç«¯ä¸€æ ·åŸºç¡€ï¼Œæƒ³åšæœåŠ¡ç«¯ç¼–ç¨‹æ˜¯ä¸å¯èƒ½ç»•è¿‡ Unix/Linux çš„ã€‚åœ¨ Linux/Unix/Mac ç³»ç»Ÿä¸­è¿è¡Œ `ps -ef` å‘½ä»¤å¯ä»¥çœ‹åˆ°å½“å‰ç³»ç»Ÿä¸­è¿è¡Œçš„è¿›ç¨‹ï¼Œå„ä¸ªå‚æ•°å¦‚ä¸‹ï¼š

- UIDï¼šæ‰§è¡Œè¯¥è¿›ç¨‹çš„ç”¨æˆ· ID
- PIDï¼šè¿›ç¨‹ç¼–å·
- PPIDï¼šè¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ç¼–å·
- Cï¼šè¯¥è¿›ç¨‹æ‰€åœ¨çš„ CPU åˆ©ç”¨ç‡
- STIMEï¼šè¿›ç¨‹æ‰§è¡Œæ—¶é—´
- TTYï¼šè¿›ç¨‹ç›¸å…³çš„ç»ˆç«¯ç±»å‹
- TIMEï¼šè¿›ç¨‹æ‰€å ç”¨çš„ CPU æ—¶é—´
- CMDï¼šåˆ›å»ºè¯¥è¿›ç¨‹çš„æŒ‡ä»¤

å…³äºè¿›ç¨‹ä»¥åŠæ“ä½œç³»ç»Ÿä¸€äº›æ›´æ·±å…¥ç»†èŠ‚æ¨èé˜…è¯» APUE å³ã€ŠUnix é«˜çº§ç¼–ç¨‹ã€‹ç­‰ä¹¦ç±æ¥äº†è§£ã€‚

## è¿›ç¨‹ä¸çº¿ç¨‹

### è¿›ç¨‹æ¦‚å¿µ

**è¿›ç¨‹**ï¼ˆProcessï¼‰æ˜¯è®¡ç®—æœºä¸­çš„ç¨‹åºå…³äºæŸæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨ï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„**åŸºæœ¬å•ä½**ï¼Œæ˜¯æ“ä½œç³»ç»Ÿç»“æ„çš„åŸºç¡€ï¼Œè¿›ç¨‹æ˜¯**çº¿ç¨‹çš„å®¹å™¨**ã€‚

è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚

æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæœåŠ¡ã€è¿è¡Œä¸€ä¸ªå®ä¾‹ï¼Œå°±æ˜¯å¼€ä¸€ä¸ªæœåŠ¡è¿›ç¨‹ï¼Œä¾‹å¦‚ Java é‡Œçš„ JVM æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒNode.js é‡Œé€šè¿‡ `node app.js` å¼€å¯ä¸€ä¸ªæœåŠ¡è¿›ç¨‹ï¼Œå¤šè¿›ç¨‹å°±æ˜¯è¿›ç¨‹çš„å¤åˆ¶ï¼ˆforkï¼‰ï¼Œfork å‡ºæ¥çš„æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´åœ°å€ã€æ•°æ®æ ˆï¼Œä¸€ä¸ªè¿›ç¨‹æ— æ³•è®¿é—®å¦å¤–ä¸€ä¸ªè¿›ç¨‹é‡Œå®šä¹‰çš„å˜é‡ã€æ•°æ®ç»“æ„ï¼Œåªæœ‰å»ºç«‹äº† IPC é€šä¿¡ï¼Œè¿›ç¨‹ä¹‹é—´æ‰å¯æ•°æ®å…±äº«ã€‚

### çº¿ç¨‹æ¦‚å¿µ

**çº¿ç¨‹**æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚

é¦–å…ˆæˆ‘ä»¬è¦æ¸…æ¥šçº¿ç¨‹æ˜¯éš¶å±äºè¿›ç¨‹çš„ï¼Œè¢«åŒ…å«äºè¿›ç¨‹ä¹‹ä¸­ã€‚**ä¸€ä¸ªçº¿ç¨‹åªèƒ½éš¶å±äºä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯ä¸€ä¸ªè¿›ç¨‹æ˜¯å¯ä»¥æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹çš„**ã€‚

#### å•çº¿ç¨‹

**å•çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹åªå¼€ä¸€ä¸ªçº¿ç¨‹**

JavaScript å°±æ˜¯å±äºå•çº¿ç¨‹ï¼Œç¨‹åºé¡ºåºæ‰§è¡Œï¼ˆè¿™é‡Œæš‚ä¸”ä¸æ JavaScript å¼‚æ­¥ï¼‰ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹é˜Ÿåˆ—ï¼Œå‰é¢ä¸€ä¸ªæ‰§è¡Œå®Œä¹‹åï¼Œåé¢æ‰å¯ä»¥æ‰§è¡Œï¼Œå½“ä½ åœ¨ä½¿ç”¨å•çº¿ç¨‹è¯­è¨€ç¼–ç æ—¶åˆ‡å‹¿æœ‰è¿‡å¤šè€—æ—¶çš„åŒæ­¥æ“ä½œï¼Œå¦åˆ™çº¿ç¨‹ä¼šé€ æˆé˜»å¡ï¼Œå¯¼è‡´åç»­å“åº”æ— æ³•å¤„ç†ã€‚ä½ å¦‚æœé‡‡ç”¨ JavaScript è¿›è¡Œç¼–ç æ—¶å€™ï¼Œè¯·å°½å¯èƒ½çš„åˆ©ç”¨ JavaScript å¼‚æ­¥æ“ä½œçš„ç‰¹æ€§ã€‚

**å•çº¿ç¨‹çš„ä¸€äº›è¯´æ˜**

- Node.js è™½ç„¶æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯å…¶åŸºäºäº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥éé˜»å¡æ¨¡å¼ï¼Œå¯ä»¥åº”ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹åˆ›å»ºã€çº¿ç¨‹ä¹‹é—´ä¸Šä¸‹æ–‡åˆ‡æ¢æ‰€äº§ç”Ÿçš„èµ„æºå¼€é”€ã€‚
- å½“ä½ çš„é¡¹ç›®ä¸­éœ€è¦æœ‰å¤§é‡è®¡ç®—ï¼ŒCPU è€—æ—¶çš„æ“ä½œæ—¶å€™ï¼Œè¦æ³¨æ„è€ƒè™‘å¼€å¯å¤šè¿›ç¨‹æ¥å®Œæˆäº†ã€‚
- Node.js å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé”™è¯¯ä¼šå¼•èµ·æ•´ä¸ªåº”ç”¨é€€å‡ºï¼Œåº”ç”¨çš„å¥å£®æ€§å€¼å¾—è€ƒéªŒï¼Œå°¤å…¶æ˜¯é”™è¯¯çš„å¼‚å¸¸æŠ›å‡ºï¼Œä»¥åŠè¿›ç¨‹å®ˆæŠ¤æ˜¯å¿…é¡»è¦åšçš„ã€‚
- å•çº¿ç¨‹æ— æ³•åˆ©ç”¨å¤šæ ¸ CPUï¼Œä½†æ˜¯åæ¥ Node.js æä¾›çš„ API ä»¥åŠä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·ç›¸åº”éƒ½å¾—åˆ°äº†è§£å†³ã€‚

## Node.js ä¸­çš„è¿›ç¨‹ä¸çº¿ç¨‹

Node.js æ˜¯ JavaScript åœ¨æœåŠ¡ç«¯çš„è¿è¡Œç¯å¢ƒï¼Œæ„å»ºåœ¨ Chrome çš„ V8 å¼•æ“ä¹‹ä¸Šï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨ã€éé˜»å¡ I/O æ¨¡å‹ï¼Œå……åˆ†åˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥ I/O è¿›è¡Œå¤šä»»åŠ¡çš„æ‰§è¡Œï¼Œé€‚åˆäº I/O å¯†é›†å‹çš„åº”ç”¨åœºæ™¯ï¼Œå› ä¸ºå¼‚æ­¥ï¼Œç¨‹åºæ— éœ€é˜»å¡ç­‰å¾…ç»“æœè¿”å›ï¼Œè€Œæ˜¯åŸºäºå›è°ƒé€šçŸ¥çš„æœºåˆ¶ï¼ŒåŸæœ¬åŒæ­¥æ¨¡å¼ç­‰å¾…çš„æ—¶é—´ï¼Œåˆ™å¯ä»¥ç”¨æ¥å¤„ç†å…¶å®ƒä»»åŠ¡ï¼Œ

> ç§‘æ™®ï¼šåœ¨ Web æœåŠ¡å™¨æ–¹é¢ï¼Œè‘—åçš„ Nginx ä¹Ÿæ˜¯é‡‡ç”¨æ­¤æ¨¡å¼ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ï¼Œé¿å…äº†å¤šçº¿ç¨‹çš„çº¿ç¨‹åˆ›å»ºã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼ŒNginx é‡‡ç”¨ C è¯­è¨€è¿›è¡Œç¼–å†™ï¼Œä¸»è¦ç”¨æ¥åšé«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨ï¼Œä¸é€‚åˆåšä¸šåŠ¡ã€‚

Web ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¦‚æœä½ æœ‰é«˜å¹¶å‘åº”ç”¨åœºæ™¯é‚£ä¹ˆ Node.js ä¼šæ˜¯ä½ ä¸é”™çš„é€‰æ‹©ã€‚

åœ¨å•æ ¸ CPU ç³»ç»Ÿä¹‹ä¸Šæˆ‘ä»¬é‡‡ç”¨ `å•è¿›ç¨‹ + å•çº¿ç¨‹` çš„æ¨¡å¼æ¥å¼€å‘ã€‚åœ¨å¤šæ ¸ CPU ç³»ç»Ÿä¹‹ä¸Šï¼Œå¯ä»¥é€šè¿‡ `child_process.fork` å¼€å¯å¤šä¸ªè¿›ç¨‹ï¼ˆNode.js åœ¨ v0.8 ç‰ˆæœ¬ä¹‹åæ–°å¢äº† **Cluster** æ¨¡å—æ¥å®ç°å¤šè¿›ç¨‹æ¶æ„ï¼‰ ï¼Œå³ `å¤šè¿›ç¨‹ + å•çº¿ç¨‹` æ¨¡å¼ã€‚

âš ï¸ **æ³¨æ„**ï¼šå¼€å¯å¤šè¿›ç¨‹ä¸æ˜¯ä¸ºäº†è§£å†³é«˜å¹¶å‘ï¼Œä¸»è¦æ˜¯è§£å†³äº†å•è¿›ç¨‹æ¨¡å¼ä¸‹ Node.js CPU åˆ©ç”¨ç‡ä¸è¶³çš„æƒ…å†µï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚

### Node.js ä¸­çš„è¿›ç¨‹

Node.js ä¸­çš„è¿›ç¨‹ Process æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œæ— éœ€ `require` åˆ™å¯ç›´æ¥ä½¿ç”¨ï¼Œç»™æˆ‘ä»¬æä¾›äº†å½“å‰è¿›ç¨‹ä¸­çš„ç›¸å…³ä¿¡æ¯ã€‚å®˜æ–¹æ–‡æ¡£æä¾›äº†è¯¦ç»†çš„è¯´æ˜ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥äº²è‡ªå®è·µä¸‹ [Process](https://nodejs.org/dist/latest-v12.x/docs/api/process.html) æ–‡æ¡£ã€‚

åœ¨ Node.js ç¨‹åºä¸­ç›´æ¥æ‰“å° `process` å¯ä»¥ç›´æ¥è·å–éå¸¸å¤šæœ‰ç”¨çš„å±æ€§ä»¥åŠæ–¹æ³•ï¼š

- è¿›ç¨‹åŸºç¡€ä¿¡æ¯
- è¿›ç¨‹ Usage
- è¿›ç¨‹çº§äº‹ä»¶
- ä¾èµ–æ¨¡å—/ç‰ˆæœ¬ä¿¡æ¯
- OS åŸºç¡€ä¿¡æ¯
- è´¦æˆ·ä¿¡æ¯
- ä¿¡å·æ”¶å‘
- ä¸‰ä¸ªæ ‡å‡†æµ

#### è¿›ç¨‹åˆ›å»º

è¿›ç¨‹åˆ›å»ºæœ‰å¤šç§æ–¹å¼ï¼Œä¸»è¦ä½¿ç”¨ Node.js çš„å¦å¤–ä¸¤ä¸ªæ¨¡å—ï¼š[child_process](./child-process.md) æ¨¡å—å’Œ [cluster](./cluster.md) æ¨¡å—ã€‚

##### child_process æ¨¡å—

`child_process` æ˜¯ Node.js çš„å†…ç½®æ¨¡å—ï¼Œç”¨äºåˆ›å»ºå­è¿›ç¨‹ã€‚

å‡ ä¸ªå¸¸ç”¨å‡½æ•°ï¼š å››ç§æ–¹å¼ï¼š

- `child_process.spawn()`ï¼šé€‚ç”¨äºè¿”å›å¤§é‡æ•°æ®ï¼Œä¾‹å¦‚å›¾åƒå¤„ç†ï¼ŒäºŒè¿›åˆ¶æ•°æ®å¤„ç†ã€‚
- `child_process.exec()`ï¼šé€‚ç”¨äºå°é‡æ•°æ®ï¼ŒmaxBuffer é»˜è®¤å€¼ä¸º 200 \* 1024 è¶…å‡ºè¿™ä¸ªé»˜è®¤å€¼å°†ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæ•°æ®é‡è¿‡å¤§å¯é‡‡ç”¨ spawnã€‚
- `child_process.execFile()`ï¼šç±»ä¼¼ `child_process.exec()`ï¼ŒåŒºåˆ«æ˜¯ä¸èƒ½é€šè¿‡ shell æ¥æ‰§è¡Œï¼Œä¸æ”¯æŒåƒ I/O é‡å®šå‘å’Œæ–‡ä»¶æŸ¥æ‰¾è¿™æ ·çš„è¡Œä¸º
- `child_process.fork()`ï¼š è¡ç”Ÿæ–°çš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ V8 å®ä¾‹ã€å†…å­˜ï¼Œç³»ç»Ÿèµ„æºæ˜¯æœ‰é™çš„ï¼Œä¸å»ºè®®è¡ç”Ÿå¤ªå¤šçš„å­è¿›ç¨‹å‡ºæ¥ï¼Œé€šå¸¸æ ¹æ®ç³»ç»Ÿ **CPU æ ¸å¿ƒæ•°**è®¾ç½®ã€‚

CPU æ ¸å¿ƒæ•°è¿™é‡Œç‰¹åˆ«è¯´æ˜ä¸‹ï¼Œfork ç¡®å®å¯ä»¥å¼€å¯å¤šä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯å¹¶ä¸å»ºè®®è¡ç”Ÿå‡ºæ¥å¤ªå¤šçš„è¿›ç¨‹ï¼ŒCPU æ ¸å¿ƒæ•°çš„è·å–æ–¹å¼ `const cpus = require('os').cpus();` è¿™é‡Œ `cpus` è¿”å›ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼ŒåŒ…å«æ‰€å®‰è£…çš„æ¯ä¸ª CPU/å†…æ ¸çš„ä¿¡æ¯ï¼ŒäºŒè€…æ€»å’Œçš„æ•°ç»„ã€‚å‡è®¾ä¸»æœºè£…æœ‰ä¸¤ä¸ª CPUï¼Œæ¯ä¸ª CPU æœ‰ 4 ä¸ªæ ¸ï¼Œé‚£ä¹ˆæ€»æ ¸æ•°å°±æ˜¯ 8ã€‚

##### cluster æ¨¡å—

Cluster æ¨¡å—è°ƒç”¨ fork æ–¹æ³•æ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œè¯¥æ–¹æ³•ä¸ `child_process` ä¸­çš„ fork æ˜¯åŒä¸€ä¸ªæ–¹æ³•ã€‚ Cluster æ¨¡å—é‡‡ç”¨çš„æ˜¯ç»å…¸çš„**ä¸»ä»æ¨¡å‹**ï¼ŒCluster ä¼šåˆ›å»ºä¸€ä¸ª masterï¼Œç„¶åæ ¹æ®ä½ æŒ‡å®šçš„æ•°é‡å¤åˆ¶å‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ `cluster.isMaster` å±æ€§åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯ master è¿˜æ˜¯ workerï¼ˆå·¥ä½œè¿›ç¨‹ï¼‰ã€‚ç”± master è¿›ç¨‹æ¥ç®¡ç†æ‰€æœ‰çš„å­è¿›ç¨‹ï¼Œä¸»è¿›ç¨‹ä¸è´Ÿè´£å…·ä½“çš„ä»»åŠ¡å¤„ç†ï¼Œä¸»è¦å·¥ä½œæ˜¯è´Ÿè´£è°ƒåº¦å’Œç®¡ç†ã€‚

Cluster æ¨¡å—ä½¿ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡æ¥æ›´å¥½åœ°å¤„ç†çº¿ç¨‹ä¹‹é—´çš„å‹åŠ›ï¼Œè¯¥è´Ÿè½½å‡è¡¡ä½¿ç”¨äº† `Round-robin` ç®—æ³•ï¼ˆä¹Ÿè¢«ç§°ä¹‹ä¸ºå¾ªç¯ç®—æ³•ï¼‰ã€‚å½“ä½¿ç”¨ Round-robin è°ƒåº¦ç­–ç•¥æ—¶ï¼Œmaster `accepts()` æ‰€æœ‰ä¼ å…¥çš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†ç›¸åº”çš„ TCP è¯·æ±‚å¤„ç†å‘é€ç»™é€‰ä¸­çš„å·¥ä½œè¿›ç¨‹ï¼ˆè¯¥æ–¹å¼ä»ç„¶é€šè¿‡ IPC æ¥è¿›è¡Œé€šä¿¡ï¼‰ã€‚

å¼€å¯å¤šè¿›ç¨‹æ—¶å€™ç«¯å£ç–‘é—®è®²è§£ï¼šå¦‚æœå¤šä¸ª Node è¿›ç¨‹ç›‘å¬åŒä¸€ä¸ªç«¯å£æ—¶ä¼šå‡ºç° `Error:listen EADDRIUNS` çš„é”™è¯¯ï¼Œè€Œ cluster æ¨¡å—ä¸ºä»€ä¹ˆå¯ä»¥è®©å¤šä¸ªå­è¿›ç¨‹ç›‘å¬åŒä¸€ä¸ªç«¯å£å‘¢ï¼ŸåŸå› æ˜¯ master è¿›ç¨‹å†…éƒ¨å¯åŠ¨äº†ä¸€ä¸ª TCP æœåŠ¡å™¨ï¼Œè€ŒçœŸæ­£ç›‘å¬ç«¯å£çš„åªæœ‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œå½“æ¥è‡ªå‰ç«¯çš„è¯·æ±‚è§¦å‘æœåŠ¡å™¨çš„ connection äº‹ä»¶åï¼Œmaster ä¼šå°†å¯¹åº”çš„ socket å¥æŸ„å‘é€ç»™å­è¿›ç¨‹ã€‚

#### è¿›ç¨‹é€šä¿¡åŸç†

å‰é¢è®²è§£çš„æ— è®ºæ˜¯ child_process æ¨¡å—ï¼Œè¿˜æ˜¯ cluster æ¨¡å—ï¼Œéƒ½éœ€è¦ä¸»è¿›ç¨‹å’Œå·¥ä½œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚é€šè¿‡ `fork()` æˆ–è€…å…¶ä»– APIï¼Œåˆ›å»ºå­è¿›ç¨‹ä¹‹åï¼Œä¸ºäº†å®ç°çˆ¶å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œçˆ¶å­è¿›ç¨‹ä¹‹é—´æ‰èƒ½é€šè¿‡ `message` å’Œ `send()` ä¼ é€’ä¿¡æ¯ã€‚

IPC è¿™ä¸ªè¯æˆ‘æƒ³å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œä¸ç®¡é‚£ä¸€ç§å¼€å‘è¯­è¨€ä¹‹é¥æåˆ°è¿›ç¨‹é€šä¿¡ï¼Œéƒ½ä¼šæåˆ°å®ƒã€‚IPC çš„å…¨ç§°æ˜¯ Inter-Process Communicationï¼Œå³è¿›ç¨‹é—´é€šä¿¡ã€‚å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†è®©ä¸åŒçš„è¿›ç¨‹èƒ½å¤Ÿäº’ç›¸è®¿é—®èµ„æºå¹¶è¿›è¡Œåè°ƒå·¥ä½œã€‚å®ç°è¿›ç¨‹é—´é€šä¿¡çš„æŠ€æœ¯æœ‰å¾ˆå¤šï¼Œå¦‚å‘½åç®¡é“ã€åŒ¿åç®¡é“ã€Socketã€ä¿¡å·é‡ã€å…±äº«å†…å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚Node ä¸­å®ç° IPC é€šé“æ˜¯ä¾èµ–äº libuvã€‚Window ä¸‹ç”±å‘½åç®¡é“ï¼ˆname pipeï¼‰å®ç°ï¼Œ\*nix ç³»ç»Ÿåˆ™é‡‡ç”¨ Unix Domain Socket å®ç°ã€‚è¡¨ç°åœ¨åº”ç”¨å±‚ä¸Šçš„è¿›ç¨‹é—´é€šä¿¡åªæœ‰ç®€å•çš„ message äº‹ä»¶å’Œ `send()` æ–¹æ³•ï¼Œæ¥å£ååˆ†ç®€æ´å’Œæ¶ˆæ¯åŒ–ã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/process/ipc-creation.png';

export default () => <img alt="å®¹å™¨çŠ¶æ€æµè½¬å›¾" src={img} width="520" />;
```

IPC é€šä¿¡ç®¡é“æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼š

```jsx | inline
import React from 'react';
import img from '../../assets/process/ipc-pipe-creation.jpeg';

export default () => <img alt="å®¹å™¨çŠ¶æ€æµè½¬å›¾" src={img} width="520" />;
```

çˆ¶è¿›ç¨‹åœ¨å®é™…åˆ›å»ºå­è¿›ç¨‹ä¹‹å‰ï¼Œä¼šåˆ›å»º IPC é€šé“å¹¶ç›‘å¬å®ƒï¼Œç„¶åæ‰çœŸæ­£çš„åˆ›å»ºå‡ºå­è¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹ä¸­ä¹Ÿä¼šé€šè¿‡ç¯å¢ƒå˜é‡ï¼ˆNODE_CHANNEL_FDï¼‰å‘Šè¯‰å­è¿›ç¨‹è¿™ä¸ª IPC é€šé“çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å­è¿›ç¨‹åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æ–‡ä»¶æè¿°ç¬¦å»è¿æ¥è¿™ä¸ªå·²å­˜åœ¨çš„ IPC é€šé“ï¼Œä»è€Œå®Œæˆçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„è¿æ¥ã€‚

#### å¥æŸ„ä¼ é€’

è®²å¥æŸ„ä¹‹å‰ï¼Œå…ˆæƒ³ä¸€ä¸ªé—®é¢˜ï¼Œ`send()` å¥æŸ„å‘é€çš„æ—¶å€™ï¼ŒçœŸçš„æ˜¯å°†æœåŠ¡å™¨å¯¹è±¡å‘é€ç»™å­è¿›ç¨‹ï¼Ÿ

**å­è¿›ç¨‹å¯¹è±¡ send æ–¹æ³•å¯ä»¥å‘é€çš„å¥æŸ„ç±»å‹**

- `net.Socket`ï¼šTCP å¥—æ¥å­—
- `net.Server`ï¼šTCP æœåŠ¡å™¨ï¼Œä»»æ„å»ºç«‹åœ¨ TCP æœåŠ¡ä¸Šçš„åº”ç”¨å±‚æœåŠ¡éƒ½å¯ä»¥äº«å—å®ƒå¸¦æ¥çš„å¥½å¤„
- `net.Native`ï¼šC++ å±‚é¢çš„ TCP å¥—æ¥å­—æˆ– IPC ç®¡é“
- `dgram.Socket`ï¼šUDP å¥—æ¥å­—
- `dgram.Native`ï¼šC++ å±‚é¢çš„ UDP å¥—æ¥å­—

**send å¥æŸ„å‘é€åŸç†åˆ†æ**

ç»“åˆå¥æŸ„çš„å‘é€ä¸è¿˜åŸç¤ºæ„å›¾æ›´å®¹æ˜“ç†è§£ã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/process/send-handle.jpeg';

export default () => <img alt="å®¹å™¨çŠ¶æ€æµè½¬å›¾" src={img} width="520"/>;
```

`send()` æ–¹æ³•åœ¨å°†æ¶ˆæ¯å‘é€åˆ° IPC ç®¡é“å‰ï¼Œå®é™…å°†æ¶ˆæ¯ç»„è£…æˆäº†ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå‚æ•°æ˜¯ hadlerï¼Œå¦ä¸€ä¸ªæ˜¯ messageã€‚message å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
{
  cmd: 'NODE_HANDLE',
  type: 'net.Server',
  msg: message
}
```

å‘é€åˆ° IPC ç®¡é“ä¸­çš„å®é™…ä¸Šæ˜¯æˆ‘ä»¬è¦å‘é€çš„å¥æŸ„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™ä¸ª message å¯¹è±¡åœ¨å†™å…¥åˆ° IPC ç®¡é“æ—¶ï¼Œä¹Ÿä¼šé€šè¿‡ `JSON.stringfy()` è¿›è¡Œåºåˆ—åŒ–ã€‚æ‰€ä»¥æœ€ç»ˆå‘é€åˆ° IPC é€šé“ä¸­çš„ä¿¡æ¯éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œ`send()` æ–¹æ³•èƒ½å‘é€æ¶ˆæ¯å’Œå¥æŸ„å¹¶ä¸æ„å‘³ç€å®ƒèƒ½å‘é€ä»»ä½•å¯¹è±¡ã€‚

è¿æ¥äº† IPC é€šé“çš„å­çº¿ç¨‹å¯ä»¥è¯»å–çˆ¶è¿›ç¨‹å‘æ¥çš„æ¶ˆæ¯ï¼Œå°†å­—ç¬¦ä¸²é€šè¿‡ `JSON.parse()` è§£æè¿˜åŸä¸ºå¯¹è±¡åï¼Œæ‰è§¦å‘ message äº‹ä»¶å°†æ¶ˆæ¯ä¼ é€’ç»™åº”ç”¨å±‚ä½¿ç”¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¶ˆæ¯å¯¹è±¡è¿˜è¦è¢«è¿›è¡Œè¿‡æ»¤å¤„ç†ï¼Œ`message.cmd` çš„å€¼å¦‚æœä»¥ `NODE_` ä¸ºå‰ç¼€ï¼Œå®ƒå°†å“åº”ä¸€ä¸ªå†…éƒ¨äº‹ä»¶ `internalMessage`ï¼Œå¦‚æœ `message.cmd` å€¼ä¸º NODE_HANDLEï¼Œå®ƒå°†å–å‡º `message.type` å€¼å’Œå¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ä¸€èµ·è¿˜åŸå‡ºä¸€ä¸ªå¯¹åº”çš„å¯¹è±¡ã€‚

ä»¥å‘é€çš„ TCP æœåŠ¡å™¨å¥æŸ„ä¸ºä¾‹ï¼Œå­è¿›ç¨‹æ”¶åˆ°æ¶ˆæ¯åçš„è¿˜åŸè¿‡ç¨‹ä»£ç å¦‚ä¸‹ï¼š

```js
function(message,handle,emit){
    var self = this;

    var server = new net.Server();
    server.listen(handler,function(){
      emit(server);
    });
}
```

è¿™æ®µè¿˜åŸä»£ç ï¼Œå­è¿›ç¨‹æ ¹æ® `message.type` åˆ›å»ºå¯¹åº”çš„ TCP æœåŠ¡å™¨å¯¹è±¡ï¼Œç„¶åç›‘å¬åˆ°æ–‡ä»¶æè¿°ç¬¦ä¸Šã€‚ç”±äºåº•å±‚ç»†èŠ‚ä¸è¢«åº”ç”¨å±‚æ„ŸçŸ¥ï¼Œæ‰€ä»¥å­è¿›ç¨‹ä¸­ï¼Œå¼€å‘è€…ä¼šæœ‰ä¸€ç§æœåŠ¡å™¨å¯¹è±¡å°±æ˜¯ä»çˆ¶è¿›ç¨‹ä¸­ç›´æ¥ä¼ é€’è¿‡æ¥çš„é”™è§‰ã€‚

> Node è¿›ç¨‹ä¹‹é—´åªæœ‰æ¶ˆæ¯ä¼ é€’ï¼Œä¸ä¼šçœŸæ­£çš„ä¼ é€’å¯¹è±¡ï¼Œè¿™ç§é”™è§‰æ˜¯æŠ½è±¡å°è£…çš„ç»“æœã€‚ç›®å‰ Node åªæ”¯æŒæˆ‘å‰é¢æåˆ°çš„å‡ ç§å¥æŸ„ï¼Œå¹¶éä»»æ„ç±»å‹çš„å¥æŸ„éƒ½èƒ½åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ï¼Œé™¤éå®ƒæœ‰å®Œæ•´çš„å‘é€å’Œè¿˜åŸçš„è¿‡ç¨‹ã€‚

#### å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹

ä»¥ä¸‹é€šè¿‡ä»£ç å®ç°å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹ç¤ºä¾‹ï¼š

```jsx | inline
import React from 'react';
import img from '../../assets/process/mutiprocess-architecture.png';

export default () => <img alt="å®¹å™¨çŠ¶æ€æµè½¬å›¾" src={img} width="520" />;
```

**ä¸»è¿›ç¨‹ï¼š**

`master.js` ä¸»è¦å¤„ç†ä»¥ä¸‹é€»è¾‘ï¼š

- åˆ›å»ºä¸€ä¸ª Server å¹¶ç›‘å¬ 3000 ç«¯å£
- æ ¹æ®ç³»ç»Ÿ CPUS å¼€å¯å¤šä¸ªå­è¿›ç¨‹
- é€šè¿‡å­è¿›ç¨‹å¯¹è±¡çš„ send æ–¹æ³•å‘é€æ¶ˆæ¯åˆ°å­è¿›ç¨‹è¿›è¡Œé€šä¿¡
- åœ¨ä¸»è¿›ç¨‹ä¸­ç›‘å¬äº†å­è¿›ç¨‹çš„å˜åŒ–ï¼Œå¦‚æœæ˜¯è‡ªæ€ä¿¡å·é‡æ–°å¯åŠ¨ä¸€ä¸ªå·¥ä½œè¿›ç¨‹
- ä¸»è¿›ç¨‹åœ¨ç›‘å¬åˆ°é€€å‡ºæ¶ˆæ¯çš„æ—¶å€™ï¼Œå…ˆé€€å‡ºå­è¿›ç¨‹å†é€€å‡ºä¸»è¿›ç¨‹

```js
// master.js
const fork = require('child_process').fork;
const cpus = require('os').cpus();

const server = require('net').createServer();
server.listen(3000);
process.title = 'node-master';

const workers = {};
const createWorker = () => {
  const worker = fork('worker.js');
  worker.on('message', function(message) {
    if (massage.act === 'suicide') {
      createWorker();
    }
  });
  worker.on('exit', function(code, signal) {
    console.log('worker process exited, code: %s signal: %s', code, signal);
    delete workers[worker.pid];
  });
  worker.send('server', server);
  workers[worker.pid] = worker;
  console.log('worker process created, pid: %s ppid: %s', worker.pid, process.pid);
};

for (let i = 0; i < cpus.length; i++) {
  createWorker();
}

process.once('SIGINT', close.bind(this, 'SIGINT')); // kill(2) Ctrl-C
process.once('SIGQUIT', close.bind(this, 'SIGQUIT')); // kill(3) Ctrl-\
process.once('SIGTERM', close.bind(this, 'SIGTERM')); // kill(15) default
process.once('exit', close.bind(this));

function close(code) {
  console.log('è¿›ç¨‹é€€å‡º', code);

  if (code !== 0) {
    for (let pid in workers) {
      console.log('master process exited, kill worker pid:', pid);
      workers[pid].kill['SIGINT'];
    }
  }

  process.exit(0);
}
```

**å­è¿›ç¨‹ï¼š**

`worker.js` å­è¿›ç¨‹å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š

- åˆ›å»ºä¸€ä¸ª Server å¯¹è±¡ï¼Œæ³¨æ„è¿™é‡Œæœ€å¼€å§‹å¹¶æ²¡æœ‰ç›‘å¬ 3000 ç«¯å£
- é€šè¿‡ message äº‹ä»¶æ¥æ”¶ä¸»è¿›ç¨‹ send æ–¹æ³•å‘é€çš„æ¶ˆæ¯
- ç›‘å¬ uncaughtException äº‹ä»¶ï¼Œæ•è·æœªå¤„ç†çš„å¼‚å¸¸ï¼Œå‘é€è‡ªæ€ä¿¡æ¯ç”±ä¸»è¿›ç¨‹é‡å»ºè¿›ç¨‹ï¼Œå­è¿›ç¨‹åœ¨é“¾æ¥å…³é—­ä¹‹åé€€å‡º

```js
// worker.js
const http = require('http');
const server = http.createServer((req, res) => {
  res.writeHead(200, {
    'Content-Type': 'text/plain',
  });
  res.end('I am worker, pid:' + process.pid + ', ppid:' + process.ppid);
  // æµ‹è¯•å¼‚å¸¸è¿›ç¨‹é€€å‡ºã€é‡å¯
  throw new Error('worker process exception!');
});

let worker;
process.title = 'node-worker';
process.on('messsage', function(message, sendHandle) {
  if (message === 'server') {
    worker = sendHandle;
    worker.on('connection', function(socket) {
      server.emit('connection', socket);
    });
  }
});

process.on('uncaguhtException', function(err) {
  console.log(err);
  process.send({ act: 'suicide' });
  worker.close(function() {
    process.exit(1);
  });
});
```

#### è¿›ç¨‹å®ˆæŠ¤

**ä»€ä¹ˆæ˜¯è¿›ç¨‹å®ˆæŠ¤ï¼Ÿ**

æ¯æ¬¡å¯åŠ¨ Node.js ç¨‹åºéƒ½éœ€è¦åœ¨å‘½ä»¤çª—å£è¾“å…¥å‘½ä»¤ `node app.js` æ‰èƒ½å¯åŠ¨ï¼Œä½†å¦‚æœæŠŠå‘½ä»¤çª—å£å…³é—­åˆ™ Node.js ç¨‹åºæœåŠ¡å°±ä¼šç«‹åˆ»æ–­æ‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå½“æˆ‘ä»¬è¿™ä¸ª Node.js æœåŠ¡æ„å¤–å¥”æºƒäº†å°±ä¸èƒ½è‡ªåŠ¨é‡å¯è¿›ç¨‹äº†ã€‚è¿™äº›ç°è±¡éƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡æŸäº›æ–¹å¼æ¥å®ˆæŠ¤è¿™ä¸ªå¼€å¯çš„è¿›ç¨‹ï¼Œæ‰§è¡Œ `node app.js` å¼€å¯ä¸€ä¸ªæœåŠ¡è¿›ç¨‹ä¹‹åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è¿™ä¸ªç»ˆç«¯ä¸Šåšäº›åˆ«çš„äº‹æƒ…ï¼Œä¸”ä¸ä¼šç›¸äº’å½±å“ï¼Œå½“å‡ºç°é—®é¢˜å¯ä»¥è‡ªåŠ¨é‡å¯ã€‚

**å¦‚ä½•å®ç°è¿›ç¨‹å®ˆæŠ¤**

è¿™é‡Œåªè¯´ä¸€äº›ç¬¬ä¸‰æ–¹çš„è¿›ç¨‹å®ˆæŠ¤æ¡†æ¶ï¼Œ[pm2](https://pm2.keymetrics.io/) å’Œ [forever](https://github.com/foreversd/forever#readme)ï¼Œå®ƒä»¬éƒ½å¯ä»¥å®ç°è¿›ç¨‹å®ˆæŠ¤ï¼Œåº•å±‚ä¹Ÿéƒ½æ˜¯é€šè¿‡ä¸Šé¢è®²çš„ child_process æ¨¡å—å’Œ cluster æ¨¡å—å®ç°çš„ï¼Œè¿™é‡Œå°±ä¸å†æå®ƒä»¬çš„åŸç†ã€‚

#### Linux å…³é—­è¿›ç¨‹

é€šè¿‡ Linux å‘½ä»¤æŸ¥æ‰¾è¿›ç¨‹

```bash
ps aux | grep server
```

æ€æ­»è¿›ç¨‹

```bash
# ä¼˜é›…çš„æ–¹å¼
# -l é€‰é¡¹å‘Šè¯‰ kill å‘½ä»¤ç”¨å¥½åƒå¯åŠ¨è¿›ç¨‹çš„ç”¨æˆ·å·²æ³¨é”€çš„æ–¹å¼ç»“æŸè¿›ç¨‹
# å½“ä½¿ç”¨è¯¥é€‰é¡¹æ—¶ï¼Œkill å‘½ä»¤ä¹Ÿè¯•å›¾æ€æ­»æ‰€ç•™ä¸‹çš„å­è¿›ç¨‹
# ä½†è¿™ä¸ªå‘½ä»¤ä¹Ÿä¸æ˜¯æ€»èƒ½æˆåŠŸï¼Œæˆ–è®¸ä»ç„¶éœ€è¦å…ˆæ‰‹å·¥æ€æ­»å­è¿›ç¨‹ï¼Œç„¶åå†æ€æ­»çˆ¶è¿›ç¨‹
kill -l [PID]

# kill å‘½ä»¤ç”¨äºç»ˆæ­¢è¿›ç¨‹
# -9 è¡¨ç¤ºå¼ºè¿«è¿›ç¨‹ç«‹å³åœæ­¢
kill -9 [PID]

# æ€æ­»åŒä¸€è¿›ç¨‹å†…çš„æ‰€æœ‰è¿›ç¨‹
# å…¶å…è®¸æŒ‡å®šè¦ç»ˆæ­¢çš„è¿›ç¨‹åç§°ï¼Œè€Œé PID
killall httpd
```

### çº¿ç¨‹

#### å…³äºå•çº¿ç¨‹çš„è¯¯åŒº

```js
const http = require('http');

const server = http.createServer();

server.listen(3000, () => {
  process.title = 'æµ‹è¯•è¿›ç¨‹';
  console.log('è¿›ç¨‹IDï¼š', process.pid);
});
```

ä¸Šè¿°ä»£ç ä¸­åˆ›å»ºäº† HTTP æœåŠ¡ï¼Œå¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œéƒ½è¯´ Node.js æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥ Node.js å¯åŠ¨åçº¿ç¨‹æ•°åº”è¯¥ä¸º 1ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¼šå¼€å¯äº† 7 ä¸ªçº¿ç¨‹å‘¢ï¼Ÿ

Node.js ä¸­æœ€æ ¸å¿ƒçš„æ˜¯ V8 å¼•æ“ï¼Œä¼šåˆ›å»º V8 çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹æ˜¯å¤šçº¿ç¨‹çš„ã€‚

- ä¸»çº¿ç¨‹ï¼šç¼–è¯‘ã€æ‰§è¡Œä»£ç 
- ç¼–è¯‘/ä¼˜åŒ–çº¿ç¨‹ï¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥ä¼˜åŒ–ä»£ç 
- åˆ†æå™¨çº¿ç¨‹ï¼šè®°å½•åˆ†æä»£ç è¿è¡Œæ—¶é—´ï¼Œä¸º Crankshaft ä¼˜åŒ–ä»£ç æ‰§è¡Œæä¾›ä¾æ®
- åƒåœ¾å›æ”¶çš„å‡ ä¸ªçº¿ç¨‹

æ‰€ä»¥å¤§å®¶å¸¸è¯´çš„ Node.js æ˜¯å•çº¿ç¨‹çš„æŒ‡çš„æ˜¯ JavaScript çš„æ‰§è¡Œæ˜¯å•çº¿ç¨‹çš„ï¼ˆå¼€å‘è€…ç¼–å†™çš„ä»£ç è¿è¡Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­ï¼‰ï¼Œä½† JavaScript çš„å®¿ä¸»ç¯å¢ƒï¼Œæ— è®ºæ˜¯ Node.js è¿˜æ˜¯æµè§ˆå™¨éƒ½æ˜¯å¤šçº¿ç¨‹çš„å› ä¸º libuv ä¸­æœ‰çº¿ç¨‹æ± çš„æ¦‚å¿µå­˜åœ¨çš„ï¼Œlibuv ä¼šé€šè¿‡ç±»ä¼¼çº¿ç¨‹æ± çš„å®ç°æ¥æ¨¡æ‹Ÿä¸åŒæ“ä½œç³»ç»Ÿçš„å¼‚æ­¥è°ƒç”¨ï¼Œè¿™å¯¹å¼€å‘è€…æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚

#### å­˜åœ¨å¼‚æ­¥ I/O å ç”¨é¢å¤–çº¿ç¨‹

è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬åœ¨å®šæ—¶å™¨æ‰§è¡Œçš„åŒæ—¶ï¼Œå»è¯»ä¸€ä¸ªæ–‡ä»¶ï¼š

```js
const fs = require('fs');

setInterval(() => {
  console.log(new Date().getTime());
}, 3000);

fs.readFile('./index.html', () => {});
```

çº¿ç¨‹æ•°é‡å˜æˆäº† 11 ä¸ªï¼Œè¿™æ˜¯å› ä¸ºåœ¨ Node ä¸­æœ‰ä¸€äº› I/O æ“ä½œï¼ˆDNSï¼ŒFSï¼‰å’Œä¸€äº› CPU å¯†é›†è®¡ç®—ï¼ˆZlibï¼ŒCryptoï¼‰ä¼šå¯ç”¨ Node çš„çº¿ç¨‹æ± ï¼Œè€Œçº¿ç¨‹æ± é»˜è®¤å¤§å°ä¸º **4**ï¼Œå› æ­¤çº¿ç¨‹æ•°å˜æˆäº† 11ã€‚

æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ›´æ”¹çº¿ç¨‹æ± é»˜è®¤å¤§å°ï¼š

```js
process.env.UV_THREADPOOL_SIZE = 64;
```

ç ä¸€è¡Œä»£ç è½»æ¾æŠŠçº¿ç¨‹å˜æˆ 71ã€‚

**Libuv**

Libuv æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å¼‚æ­¥ I/O åº“ï¼Œå®ƒç»“åˆäº† UNIX ä¸‹çš„ libev å’Œ Windows ä¸‹çš„ IOCP çš„ç‰¹æ€§ï¼Œæœ€æ—©ç”± Node çš„ä½œè€…å¼€å‘ï¼Œä¸“é—¨ä¸º Node æä¾›å¤šå¹³å°ä¸‹çš„å¼‚æ­¥ I/O æ”¯æŒã€‚Libuv æœ¬èº«æ˜¯ç”± C++ è¯­è¨€å®ç°çš„ï¼ŒNode ä¸­çš„éé˜»å¡ I/O ä»¥åŠäº‹ä»¶å¾ªç¯çš„åº•å±‚æœºåˆ¶éƒ½æ˜¯ç”± libuv å®ç°çš„ã€‚

åœ¨ Window ç¯å¢ƒä¸‹ï¼Œlibuv ç›´æ¥ä½¿ç”¨ Windows çš„ IOCP æ¥å®ç°å¼‚æ­¥ IOã€‚åœ¨é Windows ç¯å¢ƒä¸‹ï¼Œlibuv ä½¿ç”¨å¤šçº¿ç¨‹æ¥æ¨¡æ‹Ÿå¼‚æ­¥ I/Oã€‚

âš ï¸ æ³¨æ„ä¸‹é¢æˆ‘è¦è¯´çš„è¯ï¼ŒNode çš„å¼‚æ­¥è°ƒç”¨æ˜¯ç”± libuv æ¥æ”¯æŒçš„ï¼Œä»¥ä¸Šé¢çš„è¯»å–æ–‡ä»¶çš„ä¾‹å­ï¼Œè¯»æ–‡ä»¶å®è´¨çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ç”± libuv æ¥å®Œæˆçš„ï¼ŒNode åªæ˜¯è´Ÿè´£è°ƒç”¨ libuv çš„æ¥å£ï¼Œç­‰æ•°æ®è¿”å›åå†æ‰§è¡Œå¯¹åº”çš„å›è°ƒæ–¹æ³•ã€‚

#### çº¿ç¨‹åˆ›å»º

ç›´åˆ° Node 10.5.0 çš„å‘å¸ƒï¼Œå®˜æ–¹æ‰ç»™å‡ºäº†ä¸€ä¸ªå®éªŒæ€§è´¨çš„æ¨¡å— worker_threads ç»™ Node æä¾›çœŸæ­£çš„å¤šçº¿ç¨‹èƒ½åŠ›ã€‚

```js
const {
  isMainThread,
  parentPort,
  workerData,
  threadId,
  MessageChannel,
  MessagePort,
  Worker,
} = require('worker_threads');

function mainThread() {
  for (let i = 0; i < 5; i++) {
    const worker = new Worker(__filename, { workerData: i });
    worker.on('exit', code => {
      console.log(`main: worker stopped with exit code ${code}`);
    });
    worker.on('message', msg => {
      console.log(`main: receive ${msg}`);
      worker.postMessage(msg + 1);
    });
  }
}

function workerThread() {
  console.log(`worker: workerDate ${workerData}`);
  parentPort.on('message', msg => {
    console.log(`worker: receive ${msg}`);
  }),
    parentPort.postMessage(workerData);
}

if (isMainThread) {
  mainThread();
} else {
  workerThread();
}
```

ä¸Šè¿°ä»£ç åœ¨ä¸»çº¿ç¨‹ä¸­å¼€å¯äº”ä¸ªå­çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸»çº¿ç¨‹å‘å­çº¿ç¨‹å‘é€ç®€å•çš„æ¶ˆæ¯ã€‚

ç”±äº worker_thread ç›®å‰ä»ç„¶å¤„äºå®éªŒé˜¶æ®µï¼Œæ‰€ä»¥å¯åŠ¨æ—¶éœ€è¦å¢åŠ  `--experimental-worker flag`ï¼Œè¿è¡Œåè§‚å¯Ÿæ´»åŠ¨ç›‘è§†å™¨ï¼Œå¼€å¯äº† 5 ä¸ªå­çº¿ç¨‹ã€‚

**worker_thread æ¨¡å—**

[worker_thread æ ¸å¿ƒä»£ç ](https://github.com/nodejs/node/blob/master/lib/worker_threads.js)

worker_thread æ¨¡å—ä¸­æœ‰ 4 ä¸ªå¯¹è±¡å’Œ 2 ä¸ªç±»ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ä¸Šé¢çš„æºç ã€‚

- isMainThread: æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œæºç ä¸­æ˜¯é€šè¿‡ threadId === 0 è¿›è¡Œåˆ¤æ–­çš„ã€‚
- MessagePort: ç”¨äºçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œç»§æ‰¿è‡ª EventEmitterã€‚
- MessageChannel: ç”¨äºåˆ›å»ºå¼‚æ­¥ã€åŒå‘é€šä¿¡çš„é€šé“å®ä¾‹ã€‚
- threadId: çº¿ç¨‹ IDã€‚
- Worker: ç”¨äºåœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºå­çº¿ç¨‹ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¸º filenameï¼Œè¡¨ç¤ºå­çº¿ç¨‹æ‰§è¡Œçš„å…¥å£ã€‚
- parentPort: åœ¨ worker çº¿ç¨‹é‡Œæ˜¯è¡¨ç¤ºçˆ¶è¿›ç¨‹çš„ MessagePort ç±»å‹çš„å¯¹è±¡ï¼Œåœ¨ä¸»çº¿ç¨‹é‡Œä¸º null
- workerData: ç”¨äºåœ¨ä¸»è¿›ç¨‹ä¸­å‘å­è¿›ç¨‹ä¼ é€’æ•°æ®ï¼ˆdata å‰¯æœ¬ï¼‰

## å¤šè¿›ç¨‹ vs å¤šçº¿ç¨‹

| å±æ€§       | å¤šè¿›ç¨‹                                           | å¤šçº¿ç¨‹                                   | æ¯”è¾ƒ           |
| ---------- | ------------------------------------------------ | ---------------------------------------- | -------------- |
| æ•°æ®       | æ•°æ®å…±äº«å¤æ‚ï¼Œéœ€è¦ç”¨ IPCï¼›æ•°æ®æ˜¯åˆ†å¼€çš„ï¼ŒåŒæ­¥ç®€å• | å› ä¸ºå…±äº«è¿›ç¨‹æ•°æ®ï¼Œæ•°æ®å…±äº«ç®€å•ï¼ŒåŒæ­¥å¤æ‚ | å„æœ‰åƒç§‹       |
| CPUã€å†…å­˜  | å ç”¨å†…å­˜å¤šï¼Œåˆ‡æ¢å¤æ‚ï¼ŒCPU åˆ©ç”¨ç‡ä½               | å ç”¨å†…å­˜å°‘ï¼Œåˆ‡æ¢ç®€å•ï¼ŒCPU åˆ©ç”¨ç‡é«˜       | å¤šçº¿ç¨‹æ›´å¥½     |
| é”€æ¯ã€åˆ‡æ¢ | åˆ›å»ºé”€æ¯ã€åˆ‡æ¢å¤æ‚ï¼Œé€Ÿåº¦æ…¢                       | åˆ›å»ºé”€æ¯ã€åˆ‡æ¢ç®€å•ï¼Œé€Ÿåº¦å¾ˆå¿«             | å¤šçº¿ç¨‹æ›´å¥½     |
| coding     | ç¼–ç ç®€å•ã€è°ƒè¯•æ–¹ä¾¿                               | ç¼–ç ã€è°ƒè¯•å¤æ‚                           | ç¼–ç ã€è°ƒè¯•å¤æ‚ |
| å¯é æ€§     | è¿›ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¼šäº’ç›¸å½±å“                       | çº¿ç¨‹åŒå‘¼å¸å…±å‘½è¿                         | å¤šè¿›ç¨‹æ›´å¥½     |
| åˆ†å¸ƒå¼     | å¯ç”¨äºå¤šæœºå¤šæ ¸åˆ†å¸ƒå¼ï¼Œæ˜“äºæ‰©å±•                   | åªèƒ½ç”¨äºå¤šæ ¸åˆ†å¸ƒå¼                       | å¤šè¿›ç¨‹æ›´å¥½     |

---

**å‚è€ƒèµ„æ–™ï¼š**

- [ğŸ“– é¥¿äº†ä¹ˆå¤§å‰ç«¯ Node.js é¢è¯•æŒ‡å—](https://github.com/ElemeFE/node-interview/blob/master/sections/zh-cn/process.md#process)
- [ğŸ“ æ·˜å®å‰ç«¯å›¢é˜Ÿ Cluster è®²è§£](http://taobaofed.org/blog/2015/11/03/nodejs-cluster/)

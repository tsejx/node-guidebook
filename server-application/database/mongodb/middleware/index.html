<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/node-guidebook/umi.css" />
    <script>
      window.routerBase = "/node-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>ä¸­é—´ä»¶ Middleware</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/node-guidebook//overview">æ¦‚è§ˆ</a><a href="/node-guidebook//engine">å¼•æ“</a><a href="/node-guidebook//system">ç³»ç»Ÿ</a><a href="/node-guidebook//network">ç½‘ç»œ</a><a aria-current="page" class="active" href="/node-guidebook//server-application">æœåŠ¡ç«¯åº”ç”¨</a><a href="/node-guidebook//util-application">å·¥å…·åº”ç”¨</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//"></a><h1>Node Guidebook</h1><p>Node å®Œå…¨çŸ¥è¯†ä½“ç³»</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/node-guidebook//overview">æ¦‚è§ˆ</a></li><li><a href="/node-guidebook//engine">å¼•æ“</a></li><li><a href="/node-guidebook//system">ç³»ç»Ÿ</a></li><li><a href="/node-guidebook//network">ç½‘ç»œ</a></li><li><a aria-current="page" class="active" href="/node-guidebook//server-application">æœåŠ¡ç«¯åº”ç”¨</a></li><li><a href="/node-guidebook//util-application">å·¥å…·åº”ç”¨</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/node-guidebook//server-application/architect">æœåŠ¡ç«¯æ¶æ„è®¾è®¡</a><ul><li><a href="/node-guidebook//server-application/architect"><span>æ¶æ„è®¾è®¡</span></a></li><li><a href="/node-guidebook//server-application/architect/test"><span>æµ‹è¯•è®¾è®¡</span></a></li><li><a href="/node-guidebook//server-application/architect/logger"><span>æ—¥å¿—è®¾è®¡</span></a></li><li><a href="/node-guidebook//server-application/architect/gateway"><span>ç½‘å…³è®¾è®¡</span></a></li><li><a href="/node-guidebook//server-application/architect/security"><span>å®‰å…¨è®¾è®¡</span></a></li><li><a href="/node-guidebook//server-application/architect/message-queue"><span>æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li><a href="/node-guidebook//server-application/architect/database"><span>æ•°æ®åº“</span></a></li></ul></li><li><a href="/node-guidebook//server-application/message-queue/kalfa">Kalfa</a></li><li><a href="/node-guidebook//server-application/message-queue/rabbitmq">RabbitMQ</a></li><li><a href="/node-guidebook//server-application/message-queue/redis">Redis</a></li><li><a href="/node-guidebook//server-application/server-framework/mysql">MySQL</a></li><li><a href="/node-guidebook//server-application/server-framework/express">Express</a><ul><li><a href="/node-guidebook//server-application/server-framework/express"><span>Express</span></a></li><li><a href="/node-guidebook//server-application/server-framework/express/principle"><span>å®ç°åŸç†</span></a></li></ul></li><li><a href="/node-guidebook//server-application/server-framework/koa">Koa</a><ul><li><a href="/node-guidebook//server-application/server-framework/koa"><span>Koa</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/source-code"><span>æºç è§£æ</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/koa-router"><span>koa-router</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/koa-jwt"><span>koa-jwt</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/koa-helmet"><span>koa-helmet</span></a></li></ul></li><li><a href="/node-guidebook//server-application/server-framework/egg">Egg</a><ul><li><a href="/node-guidebook//server-application/server-framework/egg"><span>Egg</span></a></li><li><a href="/node-guidebook//server-application/server-framework/egg/architect"><span>æ¡†æ¶æ¶æ„</span></a></li><li><a href="/node-guidebook//server-application/server-framework/egg/core-feature"><span>æ ¸å¿ƒåŠŸèƒ½</span></a></li></ul></li><li><a href="/node-guidebook//server-application/server-framework/mongodb">MongoDB</a><ul><li><a href="/node-guidebook//server-application/server-framework/mongodb/mongodb"><span>MongoDB</span></a></li><li><a href="/node-guidebook//server-application/server-framework/mongodb/basic-usage"><span>å¸¸ç”¨æ–¹æ³•</span></a></li><li><a href="/node-guidebook//server-application/server-framework/mongodb/connections"><span>è¿æ¥ Connections</span></a></li></ul></li><li><a aria-current="page" class="active" href="/node-guidebook//server-application/database/mongodb">Database/mongodb</a><ul><li><a href="/node-guidebook//server-application/database/mongodb/aggregate"><span>èšåˆ</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/documents"><span>æ–‡æ¡£ Documents</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/hooks"><span>é’©å­å‡½æ•°</span></a></li><li><a aria-current="page" class="active" href="/node-guidebook//server-application/database/mongodb/middleware"><span>ä¸­é—´ä»¶ Middleware</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/model-api"><span>Model API</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/models"><span>æ¨¡å‹ Models</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/plugins"><span>æ’ä»¶ Plugins</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/populate"><span>å¡«å…… Populate</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/queries"><span>æŸ¥è¯¢ Queries</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/schema-types"><span>æ¨¡å¼ç±»å‹ SchemaTypes</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/schemas"><span>æ¨¡å¼ Schema</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/subdocuments"><span>å­æ–‡æ¡£ Subdocuments</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/validation"><span>éªŒè¯ Validation</span></a></li></ul></li><li><a href="/node-guidebook//server-application/pm2">Pm2</a></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="Pre" data-depth="2" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#pre"><span>Pre</span></a></li><li title="ä¸²è¡Œ" data-depth="3" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#ä¸²è¡Œ"><span>ä¸²è¡Œ</span></a></li><li title="å¹¶è¡Œ" data-depth="3" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#å¹¶è¡Œ"><span>å¹¶è¡Œ</span></a></li><li title="ä½¿ç”¨åœºæ™¯" data-depth="3" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#ä½¿ç”¨åœºæ™¯"><span>ä½¿ç”¨åœºæ™¯</span></a></li><li title="é”™è¯¯å¤„ç†" data-depth="3" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#é”™è¯¯å¤„ç†"><span>é”™è¯¯å¤„ç†</span></a></li><li title="Post" data-depth="2" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#post"><span>Post</span></a></li><li title="å¼‚æ­¥ post é’©å­" data-depth="2" class=""><a href="/node-guidebook//server-application/database/mongodb/middleware#å¼‚æ­¥-post-é’©å­"><span>å¼‚æ­¥ post é’©å­</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="ä¸­é—´ä»¶-middleware"><a aria-hidden="true" href="#ä¸­é—´ä»¶-middleware"><span class="icon icon-link"></span></a>ä¸­é—´ä»¶ Middleware</h1><p>ä¸­é—´ä»¶ï¼ˆ<code>pre</code> å’Œ <code>post</code> é’©å­ï¼‰æ˜¯åœ¨å¼‚æ­¥å‡½æ•°æ‰§è¡Œæ—¶å‡½æ•°ä¼ å…¥çš„æ§åˆ¶å‡½æ•°ã€‚</p><p>Mongoose 4.x æœ‰å››ç§ä¸­é—´ä»¶ï¼š</p><ul><li>document ä¸­é—´ä»¶</li><li>model ä¸­é—´ä»¶</li><li>aggregate ä¸­é—´ä»¶</li><li>query ä¸­é—´ä»¶</li></ul><p>å¯¹äº document ä¸­é—´ä»¶ï¼Œ<code>this</code> æŒ‡å‘å½“å‰ documentã€‚</p><p>Document ä¸­é—´ä»¶æ”¯æŒä»¥ä¸‹ document æ“ä½œï¼š</p><ul><li><code>init</code></li><li><code>validate</code></li><li><code>save</code></li><li><code>remove</code></li></ul><p>å¯¹äº <code>query</code> ä¸­é—´ä»¶ï¼Œ<code>this</code> æŒ‡å‘å½“å‰ <code>query</code>ã€‚</p><p>Query ä¸­é—´ä»¶æ”¯æŒä»¥ä¸‹ Model å’Œ Query æ“ä½œï¼š</p><ul><li><code>count</code></li><li><code>find</code></li><li><code>findOne</code></li><li><code>findOneAndRemove</code></li><li><code>findOneAndUpdate</code></li><li><code>update</code></li></ul><p>Aggregate ä¸­é—´ä»¶ä½œç”¨äº <code>MyModel.aggregate()</code>ï¼Œå®ƒä¼šåœ¨ä½ å¯¹ aggregate å¯¹è±¡è°ƒç”¨ <code>exec()</code> æ‰§è¡Œã€‚å¯¹äº aggregate ä¸­é—´ä»¶ï¼Œ<code>this</code> æŒ‡å‘å½“å‰ <code>aggregation</code> å¯¹è±¡ã€‚</p><ul><li><code>aggregate</code></li></ul><p>å¯¹äº Model ä¸­é—´ä»¶ï¼Œ<code>this</code> æŒ‡å‘å½“å‰ modelã€‚</p><p>Model ä¸­é—´ä»¶æ”¯æŒä»¥ä¸‹ Model æ“ä½œï¼š</p><ul><li><code>insertMany</code></li></ul><p>æ‰€æœ‰ä¸­é—´ä»¶æ”¯æŒ <code>pre</code> å’Œ <code>post</code> é’©å­ã€‚</p><p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šQuery æ˜¯æ²¡æœ‰ <code>remove()</code> é’©å­çš„ï¼Œåªæœ‰ document æœ‰ï¼Œå¦‚æœä½ è®¾å®šäº† <code>remove</code> é’©å­ï¼Œä»–å°†ä¼šåœ¨ä½ è°ƒç”¨ <code>myDoc.remove()</code>ï¼ˆè€Œä¸æ˜¯ <code>MyModel.remove()</code>ï¼‰æ—¶è§¦å‘ã€‚</p><h2 id="pre"><a aria-hidden="true" href="#pre"><span class="icon icon-link"></span></a>Pre</h2><p><code>pre</code> é’©å­åˆ†ä¸²è¡Œå’Œå¹¶è¡Œä¸¤ç§ã€‚</p><h3 id="ä¸²è¡Œ"><a aria-hidden="true" href="#ä¸²è¡Œ"><span class="icon icon-link"></span></a>ä¸²è¡Œ</h3><p>ä¸²è¡Œä¸­é—´ä»¶æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œä¸Šä¸€ä¸ªä¸­é—´ä»¶è°ƒç”¨ <code>next</code> å‡½æ•°æ—¶ï¼Œä¸‹ä¸€ä¸ªæ‰§è¡Œã€‚</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const schema = new Schema(..);

schema.pre(&#x27;save&#x27;, function(next){
    // do stuff
    next();
})
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> schema </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// do stuff</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>next()</code> ä¸ä¼šé˜»æ­¢å‰©ä½™ä»£ç è¿è¡Œã€‚ä½ å¯ä»¥ä½¿ç”¨ææ—© <code>return</code> æ¨¡å¼é˜»æ­¢ <code>next()</code> åé¢çš„ä»£ç è¿è¡Œã€‚</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const schema = new Schema(..);

schema.pre(&#x27;save&#x27;, function(next){
    if (foo()){
        console.log(&#x27;calling next!&#x27;)
        // `return next()` will make sure the rest of this function does&#x27;t run
        /* return */
        next();
    }
    // Unless you comment out the `return` above, &#x27;after next&#x27; will print
    console.log(&#x27;after next&#x27;);
})
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> schema </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;calling next!&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// `return next()` will make sure the rest of this function does&#x27;t run</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">/* return */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// Unless you comment out the `return` above, &#x27;after next&#x27; will print</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;after next&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="å¹¶è¡Œ"><a aria-hidden="true" href="#å¹¶è¡Œ"><span class="icon icon-link"></span></a>å¹¶è¡Œ</h3><p>å¹¶è¡Œä¸­é—´ä»¶æä¾›ç»†ç²’åº¦æµæ§åˆ¶ã€‚</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const schema = new Schema(..);

// `true` means this is a parallel middleware. You **must** specify `true`
// as the second parameter if you want to use parallel middleware.
schema.pre(&#x27;save&#x27;, true, function(next, done){
    // calling next kicks off the next middleware in parallel
    next();
    setTimeout(done, 100);
})
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> schema </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// `true` means this is a parallel middleware. You **must** specify `true`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// as the second parameter if you want to use parallel middleware.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token parameter punctuation">,</span><span class="token parameter"> done</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// calling next kicks off the next middleware in parallel</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token plain">done</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>save</code> æ–¹æ³•å°†åœ¨æ‰€æœ‰ä¸­é—´ä»¶éƒ½è°ƒç”¨äº† <code>done</code> çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œã€‚</p><h3 id="ä½¿ç”¨åœºæ™¯"><a aria-hidden="true" href="#ä½¿ç”¨åœºæ™¯"><span class="icon icon-link"></span></a>ä½¿ç”¨åœºæ™¯</h3><p>ä¸­é—´ä»¶å¯¹åŸå­åŒ–æ¨¡å‹é€»è¾‘å¾ˆæœ‰å¸®åŠ©ã€‚è¿™é‡Œæœ‰ä¸€äº›å…¶å®ƒå»ºè®®ï¼š</p><ul><li>å¤æ‚çš„æ•°æ®æ ¡éªŒ</li><li>åˆ é™¤ä¾èµ–æ–‡æ¡£ï¼ˆåˆ é™¤ç”¨æˆ·ååˆ é™¤ä»–çš„æ‰€æœ‰æ–‡ç« ï¼‰</li><li>asynchronous defaults</li><li>asynchronous tasks that a certain action triggers</li></ul><h3 id="é”™è¯¯å¤„ç†"><a aria-hidden="true" href="#é”™è¯¯å¤„ç†"><span class="icon icon-link"></span></a>é”™è¯¯å¤„ç†</h3><p>å¦‚æœ <code>pre</code> é’©å­å‡ºé”™ï¼Œmongoose å°†ä¸ä¼šæ‰§è¡Œåé¢çš„å‡½æ•°ã€‚Mongoose ä¼šå‘å›è°ƒå‡½æ•°ä¼ å…¥ <code>err</code> å‚æ•°ï¼Œæˆ–è€… <code>reject</code> è¿”å›çš„ Promiseã€‚</p><p>ğŸŒ° <strong>ç¤ºä¾‹ï¼š</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="schema.pre(&#x27;save&#x27;, funciton(next){
    const err = new Error(&#x27;something went wrong&#x27;);
    // If you call `next()` with an argument, that argument is assumed to be
    next(err);
})

schema.pre(&#x27;save&#x27;, function(){
    // You can also return a promise that rejects
    return new Promise((resolve, reject) =&gt; {
        reject(new Error(&#x27;something went wrong&#x27;));
    })
})

schema.pre(&#x27;save&#x27;, function(){
    // You can also return a promise that rejects
    throw new Error(&#x27;something went wrong&#x27;)
})

schema.pre(&#x27;save&#x27;, function(){
    await Promise.resolve();
    // You can also throw an error in an `async` function
    throw new Error(&#x27;something went wrong&#x27;);
})

// later...

// Changes will not be persisted to MongoDB becasue a pre hook errored out
myDoc.save(function(err){
    console.log(err.message);
    // something went wrong
})
" data-status="copy"></button><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> err </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;something went wrong&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// If you call `next()` with an argument, that argument is assumed to be</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// You can also return a promise that rejects</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;something went wrong&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// You can also return a promise that rejects</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;something went wrong&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// You can also throw an error in an `async` function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;something went wrong&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// later...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Changes will not be persisted to MongoDB becasue a pre hook errored out</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">myDoc</span><span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// something went wrong</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>å¤šæ¬¡è°ƒç”¨ <code>next()</code> æ˜¯æ— æ•ˆçš„ã€‚å¦‚æœä½ è°ƒç”¨ <code>next()</code> å¸¦æœ‰é”™è¯¯å‚æ•° <code>err1</code>ï¼Œç„¶åä½ å†æŠ›ä¸€ä¸ª <code>err2</code>ï¼Œmongoose åªä¼šä¼ é€’ <code>err1</code>ã€‚</p><h2 id="post"><a aria-hidden="true" href="#post"><span class="icon icon-link"></span></a>Post</h2><p><code>post</code> ä¸­é—´ä»¶åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™æ¯ä¸ª pre ä¸­é—´ä»¶éƒ½å·²ç»å®Œæˆã€‚</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="schema.post(&#x27;init&#x27;, function(doc) {
  console.log(&#x27;%s has been initialized from the db&#x27;, doc._id);
});

schema.post(&#x27;validate&#x27;, function(doc) {
  console.log(&#x27;%s has been validated (but not saved yet)&#x27;, doc._id);
});

schema.post(&#x27;save&#x27;, function(doc) {
  console.log(&#x27;%s has been saved&#x27;, doc._id);
});

schema.post(&#x27;remove&#x27;, function(doc) {
  console.log(&#x27;%s has been removed&#x27;, doc._id);
});
" data-status="copy"></button><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&#x27;init&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;%s has been initialized from the db&#x27;</span><span class="token punctuation">,</span><span class="token plain"> doc</span><span class="token punctuation">.</span><span class="token property-access">_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&#x27;validate&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;%s has been validated (but not saved yet)&#x27;</span><span class="token punctuation">,</span><span class="token plain"> doc</span><span class="token punctuation">.</span><span class="token property-access">_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;%s has been saved&#x27;</span><span class="token punctuation">,</span><span class="token plain"> doc</span><span class="token punctuation">.</span><span class="token property-access">_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&#x27;remove&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;%s has been removed&#x27;</span><span class="token punctuation">,</span><span class="token plain"> doc</span><span class="token punctuation">.</span><span class="token property-access">_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="å¼‚æ­¥-post-é’©å­"><a aria-hidden="true" href="#å¼‚æ­¥-post-é’©å­"><span class="icon icon-link"></span></a>å¼‚æ­¥ post é’©å­</h2><p>å¦‚æœä½ ç»™å›è°ƒå‡½æ•°ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼ŒMongoose ä¼šè®¤ä¸ºç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>next()</code> å‡½æ•°ï¼Œä½ å¯ä»¥é€šè¿‡ <code>next</code> è§¦å‘ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// Takes 2 parameters: this is an asynchronous post hook
schema.post(&#x27;save&#x27;, function(doc, next) {
  setTimeout(function() {
    console.log(&#x27;post1&#x27;);
    // Kick off the second post hook
    next();
  }, 10);
});

// Will not execute until the first middleware calls `next()`
schema.post(&#x27;save&#x27;, function(doc, next) {
  console.log(&#x27;post2&#x27;);
  next();
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// Takes 2 parameters: this is an asynchronous post hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;post1&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// Kick off the second post hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Will not execute until the first middleware calls `next()`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">schema</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&#x27;save&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;post2&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook/edit/master/docs/server-application/database/mongodb/middleware.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/4/2020, 3:39:37 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/node-guidebook/umi.js"></script>
    <script src="/node-guidebook/docs__server-application__database__mongodb__middleware.md.js"></script>
  </body>
</html>

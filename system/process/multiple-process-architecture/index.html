<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/node-guidebook/umi.css" />
    <script>
      window.routerBase = "/node-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/node-guidebook//overview">æ¦‚è§ˆ</a><a href="/node-guidebook//engine">å¼•æ“</a><a aria-current="page" class="active" href="/node-guidebook//system">ç³»ç»Ÿ</a><a href="/node-guidebook//network">ç½‘ç»œ</a><a href="/node-guidebook//server-application">æœåŠ¡ç«¯åº”ç”¨</a><a href="/node-guidebook//util-application">å·¥å…·åº”ç”¨</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//"></a><h1>Node Guidebook</h1><p>Node å®Œå…¨çŸ¥è¯†ä½“ç³»</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/node-guidebook//overview">æ¦‚è§ˆ</a></li><li><a href="/node-guidebook//engine">å¼•æ“</a></li><li><a aria-current="page" class="active" href="/node-guidebook//system">ç³»ç»Ÿ</a></li><li><a href="/node-guidebook//network">ç½‘ç»œ</a></li><li><a href="/node-guidebook//server-application">æœåŠ¡ç«¯åº”ç”¨</a></li><li><a href="/node-guidebook//util-application">å·¥å…·åº”ç”¨</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/node-guidebook//system/process">è¿›ç¨‹</a><ul><li><a href="/node-guidebook//system/process/process"><span>è¿›ç¨‹</span></a></li><li><a href="/node-guidebook//system/process/child-process"><span>å­è¿›ç¨‹</span></a></li><li><a href="/node-guidebook//system/process/cluster"><span>é›†ç¾¤</span></a></li><li><a href="/node-guidebook//system/process/ipc"><span>è¿›ç¨‹é—´é€šä¿¡</span></a></li><li><a href="/node-guidebook//system/process/daemon"><span>å®ˆæŠ¤è¿›ç¨‹</span></a></li><li><a aria-current="page" class="active" href="/node-guidebook//system/process/multiple-process-architecture"><span>å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹</span></a></li></ul></li><li><a href="/node-guidebook//system/io">å¼‚æ­¥ I/O</a><ul><li><a href="/node-guidebook//system/io/io"><span>æ¦‚è¿°</span></a></li><li><a href="/node-guidebook//system/io/buffer"><span>Buffer ç¼“å†²å™¨</span></a></li><li><a href="/node-guidebook//system/io/stream"><span>Stream æµ</span></a></li><li><a href="/node-guidebook//system/io/readable-stream"><span>ReadableStream å¯è¯»æµ</span></a></li><li><a href="/node-guidebook//system/io/writable-stream"><span>WritableStream å¯å†™æµ</span></a></li><li><a href="/node-guidebook//system/io/duplex-stream"><span>DuplexStream åŒå·¥æµ</span></a></li><li><a href="/node-guidebook//system/io/transform-stream"><span>TransformStream è½¬æ¢æµ</span></a></li><li><a href="/node-guidebook//system/io/string-decoder"><span>StringDecoder å­—ç¬¦ä¸²è§£ç </span></a></li><li><a href="/node-guidebook//system/io/path"><span>Path è·¯å¾„</span></a></li><li><a href="/node-guidebook//system/io/filesystem"><span>File æ–‡ä»¶ç³»ç»Ÿ</span></a></li><li><a href="/node-guidebook//system/io/console"><span>Console æ§åˆ¶å°</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="ä¸»è¿›ç¨‹" data-depth="2" class=""><a href="/node-guidebook//system/process/multiple-process-architecture#ä¸»è¿›ç¨‹"><span>ä¸»è¿›ç¨‹</span></a></li><li title="å­è¿›ç¨‹" data-depth="2" class=""><a href="/node-guidebook//system/process/multiple-process-architecture#å­è¿›ç¨‹"><span>å­è¿›ç¨‹</span></a></li><li title="çŠ¶æ€å…±äº«" data-depth="2" class=""><a href="/node-guidebook//system/process/multiple-process-architecture#çŠ¶æ€å…±äº«"><span>çŠ¶æ€å…±äº«</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹"><a aria-hidden="true" href="#å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹"><span class="icon icon-link"></span></a>å¤šè¿›ç¨‹æ¶æ„æ¨¡å‹</h1><p>å¤šè¿›ç¨‹æ¶æ„è§£å†³äº†å•è¿›ç¨‹ã€å•çº¿ç¨‹æ— æ³•å……åˆ†åˆ©ç”¨ç³»ç»Ÿå¤šæ ¸ CPU çš„é—®é¢˜ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­å®ç°å¤šè¿›ç¨‹æ¶æ„æ‰¹é‡å¯åŠ¨ Node.js è¿›ç¨‹æœåŠ¡ã€‚</p><h2 id="ä¸»è¿›ç¨‹"><a aria-hidden="true" href="#ä¸»è¿›ç¨‹"><span class="icon icon-link"></span></a>ä¸»è¿›ç¨‹</h2><ul><li>åˆ›å»º Server å¹¶ç›‘å¬æŒ‡å®šç«¯å£ï¼ˆä¾‹å¦‚ï¼š3000ï¼‰</li><li>æ ¹æ®ç³»ç»Ÿ <code>cpus</code> å¼€å¯å¤šä¸ªå­è¿›ç¨‹</li><li>é€šè¿‡å­è¿›ç¨‹å¯¹è±¡çš„ <code>send</code> æ–¹æ³•å‘æ¶ˆæ¯åˆ°å­è¿›ç¨‹è¿›è¡Œé€šä¿¡</li><li>åœ¨ä¸»è¿›ç¨‹ä¸­ç›‘å¬å­è¿›ç¨‹çš„å˜åŒ–ï¼Œå¦‚æœæ˜¯è‡ªæ€ä¿¡å·é‡æ–°å¯åŠ¨ä¸€ä¸ªå·¥ä½œè¿›ç¨‹</li><li>ä¸»è¿›ç¨‹åœ¨ç›‘å¬åˆ°é€€å‡ºæ¶ˆæ¯çš„æ—¶å€™ï¼Œå…ˆé€€å‡ºå­è¿›ç¨‹å†é€€å‡ºä¸»è¿›ç¨‹</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// master.js
const fork = require(&#x27;child_process&#x27;).fork;
const cpus = require(&#x27;os&#x27;).cpus();

const server = require(&#x27;net&#x27;).createServer();
server.listen(3000);
process.title = &#x27;node-master&#x27;;

const workers = {};
const createWorker = () =&gt; {
  const worker = fork(&#x27;worker.js&#x27;);
  worker.on(&#x27;message&#x27;, function(message) {
    if (message.act === &#x27;suicide&#x27;) {
      createWorker();
    }
  });
  worker.on(&#x27;exit&#x27;, function(code, signal) {
    console.log(&#x27;worker process exited, code: %s signal: %s&#x27;, code, signal);
    delete workers[worker.pid];
  });
  worker.on(&#x27;server&#x27;, server);
  workers[worker.pid] = worker;
  console.log(&#x27;worker process created, pid: %s ppid: %s&#x27;, worker.pid, process.pid);
};

for (let i = 0; i &lt; cpus.length; i++) {
  createWorker();
}

// kill(2) Ctrl+C
process.once(&#x27;SIGINT&#x27;, close.bind(this, &#x27;SIGINT&#x27;));
// kill(3) Ctrl+\
process.once(&#x27;SIGQUIT&#x27;, close.bind(this, &#x27;SIGQUIT&#x27;));
// kill(15) default
process.once(&#x27;SIGTERM&#x27;, close.bind(this, &#x27;SIGTERM&#x27;));
process.once(&#x27;exit&#x27;, close.bind(this));

function close(code) {
  console.log(&#x27;è¿›ç¨‹é€€å‡ºï¼&#x27;, code);

  if (code !== 0) {
    for (let pid in workers) {
      console.log(&#x27;master process exited, kill worker pid:&#x27;, pid);
      workers[pid].kill(&#x27;SIGINT&#x27;);
    }
  }

  process.exit(0);
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// master.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;child_process&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">fork</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> cpus </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;os&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;net&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;node-master&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> workers </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">createWorker</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">&#x27;worker.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">.</span><span class="token property-access">act</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;suicide&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;exit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token parameter punctuation">,</span><span class="token parameter"> signal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;worker process exited, code: %s signal: %s&#x27;</span><span class="token punctuation">,</span><span class="token plain"> code</span><span class="token punctuation">,</span><span class="token plain"> signal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">delete</span><span class="token plain"> workers</span><span class="token punctuation">[</span><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">,</span><span class="token plain"> server</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workers</span><span class="token punctuation">[</span><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> worker</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;worker process created, pid: %s ppid: %s&#x27;</span><span class="token punctuation">,</span><span class="token plain"> worker</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">,</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> cpus</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// kill(2) Ctrl+C</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGINT&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;SIGINT&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// kill(3) Ctrl+\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGQUIT&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;SIGQUIT&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// kill(15) default</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGTERM&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;SIGTERM&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;exit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;è¿›ç¨‹é€€å‡ºï¼&#x27;</span><span class="token punctuation">,</span><span class="token plain"> code</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">code </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> pid </span><span class="token keyword">in</span><span class="token plain"> workers</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;master process exited, kill worker pid:&#x27;</span><span class="token punctuation">,</span><span class="token plain"> pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      workers</span><span class="token punctuation">[</span><span class="token plain">pid</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">kill</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGINT&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="å­è¿›ç¨‹"><a aria-hidden="true" href="#å­è¿›ç¨‹"><span class="icon icon-link"></span></a>å­è¿›ç¨‹</h2><ul><li>åˆ›å»º Server å¯¹è±¡ï¼Œä¸ç”¨ç›‘å¬ç«¯å£</li><li>é€šè¿‡ <code>message</code> äº‹ä»¶æ¥æ”¶ä¸»è¿›ç¨‹ <code>send</code> æ–¹æ³•å‘é€çš„æ¶ˆæ¯</li><li>ç›‘å¬ <code>uncaughtException</code> äº‹ä»¶ï¼Œæ•è·æœªå¤„ç†çš„å¼‚å¸¸ï¼Œå‘é€è‡ªæ€ä¿¡æ¯ç”±ä¸»è¿›ç¨‹é‡å»ºè¿›ç¨‹ï¼Œå­è¿›ç¨‹åœ¨é“¾æ¥å…³é—­ä¹‹åé€€å‡º</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// worker.js
const http = require(&#x27;http&#x27;);
const server = http.createServer((req, res) =&gt; {
  res.writeHead(200, {
    &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,
  });
  res.end(&#x27;I am worker, pid:&#x27; + process.pid + &#x27;, ppid:&#x27; + process.ppid);

  throw new Error(&#x27;worker process exception!&#x27;);
  // æµ‹è¯•å¼‚å¸¸è¿›ç¨‹é€€å‡ºã€é‡å»º
});

let worker;
process.title = &#x27;node-worker&#x27;;
process.on(&#x27;message&#x27;, function(message, sendHandle) {
  if (message === &#x27;server&#x27;) {
    worker = sendHandle;
    worker.on(&#x27;connection&#x27;, function(socket) {
      server.emit(&#x27;connection&#x27;, socket);
    });
  }
});

process.on(&#x27;uncaughtException&#x27;, function(err) {
  console.log(err);
  process.send({ act: &#x27;suicide&#x27; });
  worker.close(function() {
    process.exit(1);
  });
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// worker.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> http </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;text/plain&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">&#x27;I am worker, pid:&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;, ppid:&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">ppid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;worker process exception!&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// æµ‹è¯•å¼‚å¸¸è¿›ç¨‹é€€å‡ºã€é‡å»º</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> worker</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;node-worker&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token parameter punctuation">,</span><span class="token parameter"> sendHandle</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">message </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    worker </span><span class="token operator">=</span><span class="token plain"> sendHandle</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;connection&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      server</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;connection&#x27;</span><span class="token punctuation">,</span><span class="token plain"> socket</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;uncaughtException&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> act</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;suicide&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    process</span><span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>ä»¥ä¸Šç¤ºä¾‹ç®€å•åœ°ä»‹ç»äº†å¤šè¿›ç¨‹åˆ›å»ºã€å¼‚å¸¸ç›‘å¬ã€é‡å¯ç­‰ï¼Œä½†æ˜¯ä½œä¸ºä¼ä¸šçº§åº”ç”¨ç¨‹åºæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘çš„æ›´å®Œå–„ï¼Œä¾‹å¦‚ï¼šè¿›ç¨‹çš„é‡å¯æ¬¡æ•°é™åˆ¶ã€ä¸å®ˆæŠ¤è¿›ç¨‹ç»“åˆã€å¤šè¿›ç¨‹æ¨¡å¼ä¸‹å®šæ—¶ä»»åŠ¡å¤„ç†ç­‰ã€‚æ¨èçœ‹é˜¿é‡Œ <a href="https://eggjs.org/zh-cn/core/cluster-and-ipc.html" target="_blank" rel="noopener noreferrer">Egg.js å¤šè¿›ç¨‹æ¨¡å¼<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="çŠ¶æ€å…±äº«"><a aria-hidden="true" href="#çŠ¶æ€å…±äº«"><span class="icon icon-link"></span></a>çŠ¶æ€å…±äº«</h2><blockquote><p>å¤šè¿›ç¨‹æˆ–å¤šä¸ª Web æœåŠ¡ä¹‹é—´çš„çŠ¶æ€å…±äº«é—®é¢˜ï¼Ÿ</p></blockquote><p>å¤šè¿›ç¨‹æ¨¡å¼ä¸‹å„ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¾‹å¦‚ç”¨æˆ·ç™»å½•ä¹‹å session çš„ä¿å­˜ï¼Œå¦‚æœä¿å­˜åœ¨æœåŠ¡è¿›ç¨‹é‡Œï¼Œé‚£ä¹ˆå¦‚æœæˆ‘æœ‰ 4 ä¸ªå·¥ä½œè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¦ä¿å­˜ä¸€ä»½æ˜¯æ²¡å¿…è¦çš„ï¼Œå‡è®¾æœåŠ¡é‡å¯äº†æ•°æ®ä¹Ÿä¼šä¸¢å¤±ã€‚å¤šä¸ª Web æœåŠ¡ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿˜ä¼šå‡ºç°æˆ‘åœ¨ A æœºå™¨ä¸Šåˆ›å»ºäº† Sessionï¼Œå½“è´Ÿè½½å‡è¡¡åˆ†å‘åˆ° B æœºå™¨ä¸Šä¹‹åè¿˜éœ€è¦å†åˆ›å»ºä¸€ä»½ã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯é€šè¿‡ Redis æˆ–è€…æ•°æ®åº“æ¥åšæ•°æ®å…±äº«ã€‚</p><hr/><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li><a href="https://www.cnblogs.com/tugenhua0707/p/11141076.html" target="_blank" rel="noopener noreferrer">ğŸ“ æµ…è°ˆ Node.js å¤šè¿›ç¨‹æœåŠ¡æ¶æ„åŸºæœ¬åŸç†<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://eggjs.org/zh-cn/core/cluster-and-ipc.html" target="_blank" rel="noopener noreferrer">ğŸ“– Egg.js å¤šè¿›ç¨‹æ¨¡å‹å’Œè¿›ç¨‹é—´é€šè®¯<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook/edit/master/docs/system/process/multiple-process-architecture.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/4/2020, 3:39:37 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/node-guidebook/umi.js"></script>
    <script src="/node-guidebook/docs__system__process__multiple-process-architecture.md.js"></script>
  </body>
</html>
